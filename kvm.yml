---
- hosts: local
  gather_facts: yes
  connection: local
  become: yes
  become_method: sudo
  environment:
    LIBGUESTFS_BACKEND: direct
  roles:
    - role: kvm-guest-qcow2
      ### Variables
      ## Paths
      vm_location: "/var/lib/libvirt/images"
      image: "{{ os_image }}"
      path_output: "/var/log/cloud-init.log"
      inventory_file: "./inventory.yaml"
      ## Image 
      new_image_size: "{{ disk_size }}"
      ## Owner
      dir_owner: pgoku 
      dir_group: pgoku 
      useransible: pgoku
      ## Storage
      env_LIBGUESTFS_BACKEND: "direct"
      preallocation: metadata
      ssh_keys:
        - sshkey: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbvH2rjdIDDgABBt+3FYsckeWT46jnv+Fq2LG3HQEDf pgoku@pgoku.bcnconsulting.com
      ## Users
      users:
        - name: pgoku
          groups: users,wheel
          shell: /bin/bash
          sudo: ALL=(ALL) NOPASSWD:ALL
      chg_pwd_users:
        - name: root
          password: redhat00
      ## Timezone
      timezone: "Europe/Madrid"
      ## VM definition
      guests: "{{ guest_list }}"

- ansible.builtin.import_playbook: rhn_register.yml
